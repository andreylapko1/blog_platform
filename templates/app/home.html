{% extends "base.html" %}
{% load static %}

{% block title %}Home - Community Blog{% endblock %}

{% block content %}
<div class="homepage-hero">
    <div class="container">
        <h1>{{ welcome_message }}</h1>
        <p>Делитесь своими мыслями, читайте интересные статьи и присоединяйтесь к нашему сообществу.</p>
        <a href="{% url 'post_create_view' %}" class="btn btn-primary">Создать новый пост</a>
    </div>
</div>

<main class="post-grid-section">
    <div class="container">
        <h2 class="section-title">Последние посты</h2>
        {% if posts %}
            <div class="post-grid">
                {% for post in posts %}
                    <article class="post-card">
                        <div class="post-header">
                            {% if post.author.profile.profile_image %}
                            <img src="{{ post.author.profile.profile_image.url }}" alt="{{ post.author.username }}" class="author-avatar">
                            {% else %}
                            <img src="{% static 'static/img/google_icon.png' %}" alt="Default Avatar" class="author-avatar">
                            {% endif %}
                            <div class="author-info">
                                <a href="{% url 'user_other_view' post.author.pk %}" class="author-name">{{ post.author.username }}</a>
                                <time datetime="{{ post.created_at|date:'c' }}" class="post-date">{{ post.created_at|date:"d M Y" }}</time>
                            </div>
                        </div>
                        <h2 class="post-title"><a href="{% url 'post_detail_view' post.id %}">{{ post.title }}</a></h2>
                        {% if post.image %}
                            <img src="{{ post.image.url }}" alt="{{ post.author.username }}" class="post-image">
                        {% else %}
                        {% endif %}
                        <p class="post-excerpt">{{ post.content|truncatechars:150 }}</p>

                        {# Новый контейнер для обеих кнопок #}
                        <div class="post-footer-actions">
                            {# Кнопка "Читать далее" слева #}
                            <a href="{% url 'post_detail_view' post.id %}" class="read-more-btn">Читать далее &rarr;</a>

                            {# Блок с лайками справа #}
                            <div class="post-likes-section">
                                {% if user.is_authenticated %}
                                    <button
                                        type="button"
                                        class="like-button {% if post.id in request.session.liked_posts %}liked{% endif %}" {# Updated logic here #}
                                        data-post-id="{{ post.id }}"
                                        data-action="{% if post.id in request.session.liked_posts %}unlike{% else %}like{% endif %}" {# Updated logic here #}
                                    >
                                        ❤️ <span class="total-likes">{{ post.total_likes }}</span>
                                    </button>
                                {% else %}
                                    <span class="total-likes">❤️ {{ post.total_likes }}</span>
                                    <a href="{% url 'account_login' %}" class="login-to-like-text">Войдите, чтобы лайкнуть</a>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <p class="no-posts-message">Пока нет постов. Будьте первым!</p>
        {% endif %}
    </div>
    <div class="pagination">
        <span class="step-links">
            {# Ссылка на первую страницу #}
            {% if page_obj.has_previous %}
                <a href="?page=1" class="{% if not page_obj.has_previous %}disabled{% endif %}">&laquo; Первая</a>
            {% else %}
                <span class="disabled">&laquo; Первая</span>
            {% endif %}

            {# Ссылка на предыдущую страницу #}
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}">Предыдущая</a>
            {% else %}
                <span class="disabled">Предыдущая</span>
            {% endif %}

            {# Текущая страница и общее количество страниц #}
            <span class="current">
                Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}.
            </span>

            {# Ссылка на следующую страницу #}
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">Следующая</a>
            {% else %}
                <span class="disabled">Следующая</span>
            {% endif %}

            {# Ссылка на последнюю страницу #}
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.paginator.num_pages }}">Последняя &raquo;</a>
            {% else %}
                <span class="disabled">Последняя &raquo;</span>
            {% endif %}
        </span>
    </div>
</main>
{% endblock %}
{% block extra_js %}
<script>
$(document).ready(function() {
    $('body').on('click', '.like-button', function() {
        var button = $(this);
        var post_id = button.data('post-id');
        var action = button.data('action');
        // Retrieve CSRF token from the meta tag or hidden input field
        var csrftoken = $('[name=csrfmiddlewaretoken]').val();

        // Perform the AJAX request
        $.ajax({
            url: '{% url "like_post" %}',
            type: 'POST',
            data: {
                'post_id': post_id,
                'action': action,
                'csrfmiddlewaretoken': csrftoken
            },
            success: function(response) {
                // This code runs if the server responds with a 200 OK status
                if (response.status === 'ok') {
                    // Update the displayed like count
                    button.find('.total-likes').text(response.total_likes);

                    // Toggle the 'liked' class and 'data-action' attribute for the next click
                    if (action === 'like') {
                        button.addClass('liked');
                        button.data('action', 'unlike');
                    } else {
                        button.removeClass('liked');
                        button.data('action', 'like');
                    }
                } else {
                    // If the server returns an error status in its JSON (e.g., status: 'error')
                    alert('Ошибка: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                // This code runs if the AJAX request itself fails (e.g., network error, 404, 500)
                console.error("AJAX Error:", status, error);
                alert('Произошла ошибка при обработке запроса.');
            }
        });
    });
});
</script>
{% endblock %}